@page "/Characters"
@inject CharacterViewModel Model

@if (Model.Characters == null) {
    <p><em>Save file not loaded.</em></p>
}
else {
    <p>Select the character you want to edit.</p>
    <ul class="portraits">
        @foreach (var unit in Model.Characters) {
        <li @onclick="() => SelectCharacter(unit)" class="@(Unit == unit ? "toggled" : "")">
            <img src="file://@unit.Descriptor.UISettings.PortraitPath" alt="Portrait" />
            <span>@(unit.Descriptor.CustomName ?? unit.Descriptor.Name)</span>
        </li>
        }
    </ul>
    @if (Character != null) {
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Name</label>
                <input class="form-control" type="text" @bind="@Character.CustomName" placeholder="@Character.Name" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Race</label>
                <input class="form-control" type="text" readonly="readonly" value="@Character.Progression.RaceName" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Blueprint</label>
                <input class="form-control" type="text" readonly="readonly" value="@Character.Blueprint" />
            </div>
            <div class="col-md-6">
                @if (Model.IsPlayerButNotMainCharacter(Unit)) {
                <div>
                    <label class="form-label">Sidekick</label>
                </div>
               <div>
                    <button class="btn btn-info" @onclick="() => Model.SetAsHero(Unit)">Set as hero</button>
               </div>
                }
            </div>

            <!-- TODO: Portrait -->

            <div class="col-md-3">
                <label class="form-label">Experience</label>
                <input class="form-control" type="number" @bind="@Character.Progression.Experience" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Level</label>
                <input class="form-control" type="number" readonly="readonly" value="@Character.Progression.CurrentLevel" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Mythic Level</label>
                <input class="form-control" type="number" readonly="readonly" value="@Character.Progression.MythicLevel" />
            </div>
            <div class="col-md-3">
            </div>

            <!-- TODO: Alignment -->

            <h3 class="col-md-12">Classes</h3>
            <div class="col-md-4">
                <label class="form-label">Name</label>
            </div>
            <div class="col-md-4">
                <label class="form-label">Specialization</label>
            </div>
            <div class="col-md-2">
                <label class="form-label">Level</label>
            </div>
            <div class="col-md-2">
            </div>

            @foreach (var cls in Character.Progression.Classes) {
            <div class="col-md-4">
                <label class="form-label">@cls.TypeName</label>
            </div>
            <div class="col-md-4">
                <label class="form-label">@cls.ArchetypeName</label>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" readonly="readonly" value="@cls.Level" />
            </div>
            <div class="col-md-2">
                @if (!cls.IsMythic && cls.Level > 1){
                <button class="btn btn-warning" @onclick="() => DowngradeClass(cls)">
                    <span class="oi oi-arrow-thick-bottom"></span>
                </button>
                }
            </div>
            }

            <h3 class="col-md-12">General</h3>
            <div class="col-md-4 form-list-header">
                <label class="form-label">Name</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Value</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Total</label>
            </div>
            <div class="col-md-4">
            </div>
            @foreach (var attr in Character.Stats.General) {
            <div class="col-md-4">
                <label class="form-label">@attr.Name</label>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" @bind="@attr.PairedValue" />
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" readonly="readonly" value="@attr.TotalValue" />
            </div>
            <div class="col-md-4">
            </div>
            }

            <h3 class="col-md-12">Attributes</h3>
            <div class="col-md-4 form-list-header">
                <label class="form-label">Name</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Value</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Modifiers</label>
            </div>
            <div class="col-md-4">
            </div>
            @foreach (var attr in Character.Stats.Attributes) {
            <div class="col-md-4">
                <label class="form-label">@attr.Name</label>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" @bind="@attr.PairedValue" />
            </div>
            <div class="col-md-2">
                <input class="form-control" type="text" readonly="readonly" value="@attr.ModifiersSum" />
            </div>
            <div class="col-md-4">
            </div>
            }

            <h3 class="col-md-12">Skills</h3>
            <div class="col-md-4 form-list-header">
                <label class="form-label">Name</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Value</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Total</label>
            </div>
            <div class="col-md-4">
            </div>
            @foreach (var attr in Character.Stats.Skills) {
            <div class="col-md-4">
                <label class="form-label">@attr.Name</label>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" @bind="@attr.BaseValue" />
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" readonly="readonly" value="@attr.PermanentValue" />
            </div>
            <div class="col-md-4">
            </div>
            }

            <h3 class="col-md-12">Combat</h3>
            <div class="col-md-4 form-list-header">
                <label class="form-label">Name</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Value</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Total</label>
            </div>
            <div class="col-md-4">
            </div>
            @foreach (var attr in Character.Stats.Combat) {
            <div class="col-md-4">
                <label class="form-label">@attr.Name</label>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" @bind="@attr.BaseValue" />
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" readonly="readonly" value="@attr.PermanentValue" />
            </div>
            <div class="col-md-4">
            </div>
            }

            <h3 class="col-md-12">Saves</h3>
            <div class="col-md-4 form-list-header">
                <label class="form-label">Name</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Value</label>
            </div>
            <div class="col-md-2 form-list-header">
                <label class="form-label">Total</label>
            </div>
            <div class="col-md-4">
            </div>
            @foreach (var attr in Character.Stats.Saves) {
            <div class="col-md-4">
                <label class="form-label">@attr.Name</label>
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" @bind="@attr.BaseValue" />
            </div>
            <div class="col-md-2">
                <input class="form-control" type="number" readonly="readonly" value="@attr.PermanentValue" />
            </div>
            <div class="col-md-4">
            </div>
            }
        </div>
    }
}

@code {
    private CharacterModel Character => Unit?.Descriptor;
    private UnitEntityModel Unit;

    protected override async Task OnInitializedAsync()
    {
    }

    public async Task SelectCharacter(UnitEntityModel unit)
    {
        Unit = unit;
    }

    public async Task DowngradeClass(ClassModel cls)
    {
        Model.DowngradeClass(Unit, cls);
    }
}